# Библиотека YtSync
Библиотека для написания инструментов управления базой данных поверх динамических YT-таблиц.

Техническая поддержка осуществляется в очереди
[YTADMINREQ](https://st.yandex-team.ru/createTicket?queue=YTADMINREQ&_form=66687c0940e3616bc9593a62).
При обращении выбирать компонент YT Sync.

Код библиотеки живет по пути
[`yt/yt_sync`](https://a.yandex-team.ru/arcadia/yt/yt_sync).

## Возможности
Управление свойствами группы [динамических таблиц YT](https://yt.yandex-team.ru/docs/user-guide/dynamic-tables/overview):
- поддерживаются standalone, [реплицированные](https://yt.yandex-team.ru/docs/user-guide/dynamic-tables/replicated-dynamic-tables) и хаосные таблицы
- поддерживаются [YT Queues и консьюмеры](https://yt.yandex-team.ru/docs/user-guide/dynamic-tables/queues) (standalone, реплицированные, и хаосные)
- управление [коллокациями](https://yt.yandex-team.ru/docs/user-guide/dynamic-tables/replicated-dynamic-tables#replication_collocation)
таблиц (реплицированные и хаосные)
- изменение свойств колонок таблиц: `group`, `lock`, `sort_order` (можно только поменять), `expression`
(можно только поменять), `required` (можно только выставить `false` если было `true`), `aggregate` (можно только
добавить или поменять, удалить нельзя), `max_inline_hunk_size` (можно только добавить или поменять в бОльшую сторону)
- изменение схемы таблицы: добавление или удаление колонок, изменение ключа таблицы (если все вместе - то с полным downtime таблицы на чтение и запись)
- изменение атрибутов таблиц
- (пере)создание таблиц
- дамп в лог отличий желаемого состояния от текущего
- dry-run режим: можно в логе посмотреть какие будут выполнены операции по модификации таблиц, но при этом реального
 вызова модифицирующих команд YT API не произойдет
- возможность на базе YtSync реализовывать свои сценарии управления таблицами


## Отличия от старого YtSync
Старый yt_sync живет здесь: [ads/caesar/libs/yt_sync](https://a.yandex-team.ru/arcadia/ads/caesar/libs/yt_sync).

Отличия:
- по максимуму используется [YT Batch client](https://yt.yandex-team.ru/docs/api/python/examples#batch_queries), за
счёт этого многие операции выполняются параллельно, что приводит к ускорению
- поддержка YT Chaos инсталляций
- оптимизации в `ensure` чтобы свести недоступность таблиц к минимуму во время изменений:
  - во время изменений через `alter_table` работа с таблицей невозможна только когда отмонтируем реплицированную таблицу
  и синхронную реплику (отмонтирование/модификация/монтирование происходит по очереди на каждом кластере), либо
  на время переключения синхронности реплик
  - во время изменения через `map`/`sort` работа с таблицей невозможна только когда отмонтируем реплицированную таблицу
  и на время переключения синхронности реплик
- можно дописывать свои собственные сценарии по работе с базой
